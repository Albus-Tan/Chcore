# Lab6

> 姓名：谈子铭
>
> 学号：520021910607

> 思考题 1：请自行查阅资料，并阅读`userland/servers/sd`中的代码，回答以下问题:
>
> - circle中还提供了SDHost的代码。SD卡，EMMC和SDHost三者之间的关系是怎么样的？
> - 请**详细**描述Chcore是如何与SD卡进行交互的？即Chcore发出的指令是如何输送到SD卡上，又是如何得到SD卡的响应的。(提示: IO设备常使用MMIO的方式映射到内存空间当中)
> - 请简要介绍一下SD卡驱动的初始化流程。
> - 在驱动代码的初始化当中，设置时钟频率的意义是什么？为什么需要调用`TimeoutWait`进行等待?

**SD卡，EMMC和SDHost三者之间的关系是怎么样的？**

- SD卡（Secure Digital Card）是一种可移动存储设备，可以插入到支持SD卡接口的设备中，用于在便携式设备中存储数据
- EMMC（Embedded MultiMediaCard）是一种集成了控制器和闪存芯片的嵌入式存储设备，它的接口与SD卡相同，但通常具有更高的存储容量和更快的读写速度
- SDHost是一种标准接口协议，用于控制SD卡和EMMC这样的存储设备。SDHost作为一个软件层，提供了对SD卡和EMMC的抽象接口，使得操作系统和应用程序能够方便地操作存储设备

SD卡和EMMC是实际的存储设备，而SDHost则是一个标准化的接口协议，用于控制和管理这些存储设备。SDHost充当了SD卡和EMMC与操作系统之间的桥梁，使得操作系统和驱动程序能够通过SDHost与存储设备进行交互，并进行读写操作。

**Chcore是如何与SD卡进行交互的？**

在Chcore中，与SD卡的交互是通过MMIO（Memory Mapped I/O）方式实现的。MMIO是一种常见的将I/O设备映射到内存地址空间的技术，使得CPU可以像访问内存一样访问I/O设备。

Chcore通过以下步骤与SD卡进行交互：

1. 初始化：Chcore在启动时会初始化SD卡驱动程序，并对SDHost进行配置和初始化。这包括设置SDHost的寄存器、时钟频率、电压等参数，以确保与SD卡通信的正确性。
2. 写指令：当Chcore需要向SD卡发送指令时，它会将指令的数据和参数写入到预先映射的SDHost寄存器中。这些寄存器被映射到内存空间的特定地址范围，使得CPU可以通过内存访问的方式写入数据。
3. 发送指令：Chcore通过向SDHost的寄存器写入特定的命令代码来触发指令的发送。SDHost会根据写入的命令代码执行相应的操作，将指令传递给SD卡。
4. SD卡响应：SD卡接收到指令后会执行相应的操作，并将响应数据返回给SDHost。SDHost会将SD卡的响应数据存储在预先映射的寄存器中，等待Chcore读取。
5. 读取响应：Chcore通过从预先映射的寄存器中读取响应数据，获取SD卡对指令的响应。Chcore可以根据响应数据来判断指令执行的结果，并采取相应的处理措施。

整个过程中，Chcore通过将SDHost的寄存器映射到内存空间中的特定地址范围，使得CPU可以通过内存访问的方式与SDHost进行通信。Chcore将指令和数据写入到相应的寄存器中，触发SDHost向SD卡发送指令，并从寄存器中读取SD卡的响应。这种基于MMIO的方式使得Chcore能够与SD卡进行高效的交互，并进行数据的读写操作。

**请简要介绍一下SD卡驱动的初始化流程**

`emmc.c` 文件 `CardInit` 函数

1. 首先调用 `PowerOn()` 函数来执行SD卡的上电操作。如果上电失败，返回-1表示初始化失败。
2. 获取版本号并进行版本检查。
3. 循环执行重置SD卡的 `CardReset()` 函数。

`emmc.c` 文件 `CardReset()` 函数

1. 检查是否定义了 `USE_SDHOST` 宏，如果没有定义 `USE_SDHOST` 宏，则执行其中的代码块
2. 根据树莓派版本执行一些操作，然后检查是否插入了有效的SD卡
3. 获取基本时钟频率，如果无法获取，则将基本时钟频率设置为默认值
4. 设置时钟频率为较慢的速度，通过配置 `EMMC_CONTROL1` 寄存器的相关位实现
5. 启用SD时钟，并等待时钟稳定
6. 屏蔽掉将中断发送给ARM处理器，重置中断寄存器
7. 将所有中断发送到中断寄存器，并设置中断掩码
8. 准备设备结构的相关变量
9. 发送一系列命令与SD卡进行通信，包括发送CMD0、CMD8、ACMD41等命令，获取卡片信息和进行初始化
10. 获取卡片CID、发送CMD3命令进入数据状态、选择卡片、设置块长度等

**在驱动代码的初始化当中，设置时钟频率的意义是什么？为什么需要调用`TimeoutWait`进行等待?**

在驱动代码的初始化过程中，设置时钟频率的意义是为了控制设备的时序和工作速率。时钟频率决定了设备内部操作的速度和时间间隔，对于各种设备和总线接口来说都非常重要。

通过设置适当的时钟频率，可以确保设备在正常工作范围内运行，并与其他设备或系统组件同步。例如，对于一些外部设备接口如串行通信接口（UART）、SPI（串行外设接口）或 I2C（双线串行总线），设置正确的时钟频率可以确保数据传输的稳定性和正确性。

调用 `TimeoutWait` 是为了等待设备的时钟和状态稳定。在SD卡的初始化过程中，发送命令后需要等待SD卡的响应，以确保命令被成功接收和执行。使用 `TimeoutWait` 函数可以设置一个最大等待时间，如果超过这个时间SD卡没有响应，可以认为操作失败或SD卡出现问题。

等待的原因可能有多种，例如SD卡正在执行某个复杂的操作，或者SD卡在某些情况下需要更长的时间来完成特定的操作。通过适当的等待时间，可以确保SD卡的状态正确，并且可以在适当的时机进行后续的操作，如读取或写入数据。

> 思考题：查阅资料了解 SD 卡是如何进行分区，又是如何识别分区对应的文件系统的？尝试设计方案为 ChCore 提供多分区的 SD 卡驱动支持，设计其解析与挂载流程。本题的设计部分请在实验报告中详细描述，如果有代码实现，可以编写对应的测试程序放入仓库中提交。

1. **SD卡的分区**：
   SD卡的分区是指将物理上的SD卡划分为多个逻辑上独立的区域，每个区域可以被视为一个独立的存储设备。分区的目的是允许在同一个SD卡上存储不同类型的数据或在不同操作系统之间共享数据。SD卡的分区通常使用分区表来描述各个分区的位置和大小。

   SD卡分区的过程通常在计算机上完成，以下是一般的分区过程：
   - 使用分区工具（如磁盘管理工具）将SD卡分区为多个逻辑分区。
   - 为每个分区分配一个唯一的标识符（通常是分区号）。
   - 在SD卡的分区表中记录每个分区的位置、大小和标识符等信息。

   分区后的SD卡可以在计算机或其他设备上以多个独立的存储设备进行访问。每个分区可以独立地格式化为不同的文件系统，例如FAT32、NTFS、exFAT等。

2. **文件系统的识别**：
   文件系统是用于在存储设备上组织和管理文件和目录的一种结构。SD卡上的每个分区可以格式化为不同的文件系统，而文件系统的识别是指在访问SD卡时，如何确定每个分区所使用的文件系统类型。

   文件系统的识别通常通过读取分区的引导扇区或特定的文件系统标识来完成。以下是一般的文件系统识别过程：
   - 在读取SD卡时，根据分区表确定每个分区的起始扇区和大小。
   - 读取分区的引导扇区（通常是分区的第一个扇区）。
   - 分析引导扇区的内容，检查文件系统标识或特定的文件系统结构来确定文件系统类型。

   不同的文件系统有不同的标识和结构，例如FAT文件系统具有特定的引导扇区结构和文件系统标识，NTFS文件系统有不同的引导扇区结构和特定的文件系统标识等。根据文件系统的标识和结构，系统可以确定分区所使用的文件系统类型，并相应地解析和访问文件和目录。

综上所述，SD卡的分区是通过分区表进行管理和划分的，而文件系统的识别则是根据分区的引导扇区内容来确定每个分区所使用的文件系统类型。